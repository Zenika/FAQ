import React, { Component } from 'react'
import PropTypes from 'prop-types'
import { Redirect, Prompt } from 'react-router-dom'
import differenceWith from 'lodash/differenceWith'
import isEqual from 'lodash/isEqual'

import { compose } from 'react-apollo'
import { submitAnswer, editAnswer } from './queries'

import { alert, markdown, useIntl } from 'services'
import { isUuidV4, onListChange } from 'helpers'

import NotFound from 'scenes/NotFound'

import {
  withLoading,
  Loading,
  Flags,
  Button,
  MarkdownEditor,
  CtrlEnter,
  PairInputList
} from 'components'
import Card, { CardTitle, CardText, CardActions, PermanentClosableCard } from 'components/Card'

import { ActionMenu } from '../../components'

import Tips from './components/Tips'

class Answer extends Component {
  constructor(props) {
    super(props)

    const answer = props.zNode && props.zNode.answer

    const initialText = answer ? answer.content : ''
    const initialSources = this.sourcesToKeyValuePairs(answer ? answer.sources : [])

    this.state = {
      nodeLoaded: false,
      initialAnswer: initialText,
      answer: initialText,
      loading: false,
      sources: initialSources,
      initialSources: initialSources,
      slug: null,
      showTips: PermanentClosableCard.isOpen('tips_answer')
    }
  }

  sourcesToKeyValuePairs(sources) {
    return sources.map(({ id, label, url }) => ({
      id,
      key: label,
      value: url
    }))
  }

  keyValuePairsToSources(list) {
    return list
      .map(({ id, key, value }) => {
        // If the id was generated by the frontend, filter it
        if (isUuidV4(id)) {
          return { label: key, url: value }
        }
        return { id, label: key, url: value }
      })
      .filter(({ label, url }) => label !== '' && url !== '')
  }

  onTextChange = value => this.setState({ answer: value })
  onSourcesChange = onListChange(this.setState.bind(this), 'sources')

  submitForm = () => {
    if (this.canSubmit()) {
      const { zNode } = this.props
      zNode.answer ? this.editAnswer() : this.submitAnswer()
    }
  }

  submitAnswer = () => {
    const intl = useIntl(Answer)

    const { submitAnswer } = this.props
    const { zNode } = this.props
    const { answer, sources } = this.state

    this.setState({ loadingSubmit: true })

    submitAnswer(answer, this.keyValuePairsToSources(sources), zNode.id)
      .then(() => {
        this.setState({ slug: zNode.question.slug + '-' + zNode.id })
        alert.pushSuccess(intl('alert.submit_success'))
      })
      .catch(error => {
        alert.pushDefaultError(error)
        this.setState({
          loadingSubmit: false
        })
      })
  }

  editAnswer = (nodeId, answerId) => {
    const intl = useIntl(Answer)

    const { editAnswer, zNode } = this.props
    const { answer, sources } = this.state

    this.setState({ loadingSubmit: true })

    editAnswer(
      typeof answerId === 'string' ? answerId : zNode.answer.id,
      answer,
      this.state.initialAnswer,
      this.keyValuePairsToSources(sources)
    )
      .then(() => {
        this.setState({ slug: zNode.question.slug + '-' + zNode.id })
        alert.pushSuccess(intl('alert.edit_success'))
      })
      .catch(error => {
        alert.pushDefaultError(error)
        this.setState({
          loadingSubmit: false
        })
      })
  }

  openTips = () => {
    this.setState({ showTips: true })
    PermanentClosableCard.setValue('tips_answer', true)
  }

  closeTips = () => {
    this.setState({ showTips: false })
    PermanentClosableCard.setValue('tips_answer', false)
  }

  canSubmit() {
    const { answer, initialAnswer, sources, initialSources } = this.state
    return !(
      answer.length === 0 ||
      (answer === initialAnswer &&
        differenceWith(sources, initialSources, isEqual).length === 0 &&
        differenceWith(initialSources, sources, isEqual).length === 0)
    )
  }

  render() {
    const intl = useIntl(Answer)

    const { loadingSubmit, slug, showTips, sources } = this.state
    const { zNode } = this.props

    if (slug) {
      return <Redirect to={`/q/${slug}`} />
    }

    if (loadingSubmit) {
      return <Loading />
    }

    if (zNode === null) {
      return <NotFound />
    }

    return (
      <div>
        {this.canSubmit() && <Prompt message={intl('prompt_warning')} />}
        <ActionMenu backLink={`/q/${zNode.question.slug}-${zNode.id}`}>
          {!showTips && (
            <Button
              link
              icon="lightbulb_outline"
              label={intl('show_tips')}
              onClick={this.openTips}
            />
          )}
        </ActionMenu>
        <Tips close={this.closeTips} open={showTips} />
        <Card style={{ marginTop: '0.3rem' }}>
          <CardTitle style={{ padding: '1.2rem' }}>
            <div className="grow">
              <h1>{markdown.title(zNode.question.title)}</h1>
            </div>
            <Flags node={zNode} withLabels={true} />
          </CardTitle>
          <CardText>
            <CtrlEnter onCtrlEnterCallback={this.submitForm}>
              <MarkdownEditor content={this.state.answer} onChange={this.onTextChange} />
            </CtrlEnter>
          </CardText>
          <CardText>
            <PairInputList
              style={{ borderTop: '1px dashed var(--secondary-color)' }}
              pairs={sources}
              options={{
                title: intl('sources.title'),
                icons: { line: 'info_outline', value: 'link' },
                labels: intl('sources.labels')
              }}
              actions={this.onSourcesChange.actions}
            />
          </CardText>
          <CardActions>
            <Button
              label={zNode.answer ? intl('validate.edit') : intl('validate.submit')}
              primary
              raised
              disabled={!this.canSubmit()}
              onClick={this.submitForm}
            />
          </CardActions>
        </Card>
      </div>
    )
  }
}

Answer.propTypes = {
  match: PropTypes.object.isRequired,
  submitAnswer: PropTypes.func.isRequired,
  editAnswer: PropTypes.func.isRequired,
  zNode: PropTypes.object
}

Answer.translations = {
  en: {
    alert: {
      submit_success: 'Your answer was successfully submitted!',
      edit_success: 'The answer was successfully edited!'
    },
    prompt_warning: 'Are you sure you want to leave this page with an unsaved answer?',
    show_tips: 'Show tips',
    sources: {
      title: 'Sources:',
      labels: {
        add: 'Add a source link',
        more: 'More sources',
        key: 'Label',
        value: 'URL'
      }
    },
    validate: {
      submit: 'Submit answer',
      edit: 'Save answer'
    }
  },
  fr: {
    alert: {
      submit_success: 'Votre réponse a bien été envoyée !',
      edit_success: 'La réponse a bien été modifiée !'
    },
    prompt_warning: 'Êtes-vous sûr de vouloir quitter cette page sans enregistrer la réponse ?',
    show_tips: 'Voir conseils',
    sources: {
      title: 'Sources:',
      labels: {
        add: 'Ajouter une source',
        more: 'Plus de sources',
        key: 'Label',
        value: 'URL'
      }
    },
    validate: {
      submit: 'Envoyer la réponse',
      edit: 'Enregistrer la réponse'
    }
  }
}

export default compose(
  submitAnswer,
  editAnswer,
  withLoading()
)(Answer)
